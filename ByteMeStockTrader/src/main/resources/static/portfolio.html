<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Hub</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <script defer src="/js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <!-- Level 1: Banner -->
    <div class="banner">Byte Me Inc. ü§ñ</div>

    <div class="main-content">
      <div class="portfolio-container">
        <!-- Level 2: Header -->
        <div class="header">
          <h1>Auto <span id="stockName">NVDA</span> Trader Hub</h1>
          <button id="tradingStatusButton" class="trading-button active">
            Actively Trading
          </button>
        </div>

        <!-- Level 3: Slider and Upload Counter -->
        <div class="level-3">
          <!-- Slider -->
          <div class="slider-container">
            <p><strong>Select Data Interval:</strong></p>
            <input
              type="range"
              id="intervalSlider"
              name="intervalSlider"
              min="1"
              max="4"
              value="1"
              step="1"
            />
            <div class="slider-labels">
              <span>10 min.</span>
              <span>30 min.</span>
              <span>1 hr.</span>
              <span>2 hr.</span>
            </div>
          </div>

          <!-- Upload Counter Number with Square Border -->
          <div class="upload-counter-container">
            <div class="upload-counter">0</div>
          </div>
        </div>

        <!-- Level 4: Stock State and Portfolio State -->
        <div class="level-4">
          <div class="square-box sentiment-visualizer">
            <div class="visualizer-container">
              <div class="gradient-box">
                <p class="sentiment-title">Current News Sentiment</p>
                <canvas
                  id="sentimentVisualizer"
                  width="300"
                  height="75"
                ></canvas>
              </div>
              <div class="bar-chart-container">
                <p class="bar-chart-title" style="margin-bottom: 1px">
                  Key Metrics
                </p>
                <canvas id="metricsBarChart" width="200" height="150"></canvas>
              </div>
            </div>
          </div>

          <!-- Right Square -->
          <div class="square-box" id="portfolioBox">
            <p id="portfolioLoading"></p>
            <div class="spinner" id="portfolioSpinner"></div>
            <div id="portfolioText"></div>
            <canvas
              id="portfolioChart"
              width="400"
              height="300"
              style="display: none"
            ></canvas>
          </div>
        </div>

        <!-- Level 5: Feed and Buttons -->
        <div class="feed">
          <h3>Recent Activity</h3>
          <div class="feed-content" id="feedContent">
            <p>
              Welcome to your very own automated
              <span id="stockName2">NVDA</span> trader! üöÄ
            </p>
            <p>
              The slider in the top left indicates how frequent data is
              retreived on your stock. ‚è±Ô∏è üìä
            </p>
            <p>
              Everytime data is retreived, the counter beside the slider is
              incremented. üßÆ
            </p>
            <p>
              Once the counter reaches 10, your trader will analyze the data and
              decide/make the wisest trading move based on it's training! üí∞
            </p>
            <p>
              Press the green button in the top right to pause operations at any
              time. üõë
            </p>
          </div>
        </div>
        <div class="login-button-group">
          <!--
          <button id="fetchDataButton" onclick="fetchStockData()">
            Fetch Data
          </button>
          -->
          <button
            id="changeStockButton"
            onclick="window.location.href='/stock-selection.html'"
          >
            Change Stock
          </button>
        </div>
      </div>
    </div>

    <script>
      // Update stock names in header and other places
      window.addEventListener("load", function () {
        const selectedStock =
          document.getElementById("selectedStock").textContent;
        document.getElementById("stockName").textContent = selectedStock;
        document.getElementById("stockName2").textContent = selectedStock;
      });

      async function fetchStockData() {
        const selectedStock =
          document.getElementById("selectedStock").textContent;

        // Fetch data from backend
        const response = await fetch(`/api/trade?symbol=${selectedStock}`);
        const data = await response.json();

        // Reference to feed content
        const feedContent = document.getElementById("feedContent");

        if (data.error) {
          feedContent.insertAdjacentHTML("afterbegin", `<p>${data.error}</p>`);
          return;
        }

        // Prepend the new fetched data to the top of feed content
        const newDataHtml = `
        <p>Symbol: ${data.symbol}</p>
        <p>Open Price: ${data.open_price}</p>
        <p>Previous Close Price: ${data.previous_close_price}</p>
        <p>Positive Sentiment: ${data.positiveSentiment}</p>
        <p>Neutral Sentiment: ${data.neutralSentiment}</p>
        <p>Negative Sentiment: ${data.negativeSentiment}</p>
        <!-- ... other data ... -->
      `;

        // Insert new data at the top
        feedContent.insertAdjacentHTML("afterbegin", newDataHtml);
      }

      async function fetchUploadCounter() {
        const response = await fetch("/api/uploadCounter");
        const uploadCounter = await response.json();
        document.getElementById("uploadCounter").textContent = uploadCounter;
      }

      // Fetch the upload counter when the page loads
      window.addEventListener("load", fetchUploadCounter);

      async function fetchPortfolioData() {
        const response = await fetch("/api/portfolio");
        const portfolioBox = document.getElementById("portfolioBox");
        const loadingText = document.getElementById("portfolioLoading");
        const spinner = document.getElementById("portfolioSpinner");
        const chartCanvas = document.getElementById("portfolioChart");

        if (response.ok) {
          const portfolioData = await response.json();

          const account = portfolioData.account;
          const positions = portfolioData.positions;

          const cash = parseFloat(account.cash).toFixed(2);
          const portfolioValue = parseFloat(account.portfolio_value).toFixed(2);

          spinner.style.display = "none";

          const selectedStockData = positions.find(
            (pos) => pos.symbol === "NVDA"
          );
          const shares = selectedStockData ? selectedStockData.qty : 0;

          portfolioBox.innerHTML = `
        <p>Portfolio Value: $${portfolioValue}</p>
        <p>Cash to Trade: $${cash}</p>
        <p>Shares NVDA: ${shares}</p>
        <canvas id="portfolioChart" width="400" height="300"></canvas>
      `;

          const ctx = document
            .getElementById("portfolioChart")
            .getContext("2d");
          const labels = positions.map((pos) => pos.symbol);
          const values = positions.map((pos) => parseFloat(pos.market_value));

          new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: labels,
              datasets: [
                {
                  data: values,
                  backgroundColor: [
                    "#FF6384",
                    "#36A2EB",
                    "#FFCE56",
                    "#4BC0C0",
                    "#9966FF",
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "top",
                },
                tooltip: {
                  callbacks: {
                    label: function (tooltipItem) {
                      const value = tooltipItem.raw / 100; // Adjust the value
                      return `${tooltipItem.label}: ${value.toFixed(2)}%`;
                    },
                  },
                },
              },
            },
          });

          portfolioBox.classList.add("loaded"); // Trigger transition to final content
        } else {
          console.error("Failed to fetch portfolio data:", response.status);
          loadingText.textContent = "Error loading portfolio data.";
        }
      }

      window.addEventListener("load", fetchPortfolioData);

      document
        .getElementById("tradingStatusButton")
        .addEventListener("click", async function () {
          const tradingStatusButton = document.getElementById(
            "tradingStatusButton"
          );

          // Update UI styles
          if (tradingStatusButton.classList.contains("active")) {
            tradingStatusButton.classList.remove("active");
            tradingStatusButton.classList.add("inactive");
            tradingStatusButton.textContent = "Deactivated";
            tradingStatusButton.style.backgroundColor = "#dc3545";
          } else {
            tradingStatusButton.classList.remove("inactive");
            tradingStatusButton.classList.add("active");
            tradingStatusButton.textContent = "Actively Trading";
            tradingStatusButton.style.backgroundColor = "#28a745";
          }

          // Send a signal to the backend to toggle the trading status
          try {
            const response = await fetch("/sc/toggleTrader", {
              method: "GET",
            });

            if (!response.ok) {
              console.error(
                "Failed to toggle trading status:",
                response.status
              );
            } else {
              console.log("Trading status toggled successfully.");
            }
          } catch (error) {
            console.error("Error toggling trading status:", error);
          }
        });

      window.addEventListener("load", function () {
        // ** News Sentiment Gradient Rectangle **
        const sentimentCanvas = document.getElementById("sentimentVisualizer");
        const sentimentCtx = sentimentCanvas.getContext("2d");

        const sentimentData = {
          positive: 5,
          neutral: 1,
          negative: 2,
        };

        const total =
          sentimentData.positive +
          sentimentData.neutral +
          sentimentData.negative;
        const positivePercentage = sentimentData.positive / total;
        const neutralPercentage = sentimentData.neutral / total;
        const negativePercentage = sentimentData.negative / total;

        const sentimentWidth = sentimentCanvas.width;
        const sentimentHeight = sentimentCanvas.height;
        const positiveWidth = sentimentWidth * positivePercentage;
        const neutralWidth = sentimentWidth * neutralPercentage;
        const negativeWidth = sentimentWidth * negativePercentage;

        const positiveColor = "#56D798";
        const neutralColor = "#FFD97D";
        const negativeColor = "#FF6B6B";

        const positiveNeutralGradient = sentimentCtx.createLinearGradient(
          0,
          0,
          positiveWidth + neutralWidth,
          0
        );
        positiveNeutralGradient.addColorStop(0, positiveColor);
        positiveNeutralGradient.addColorStop(1, neutralColor);

        const neutralNegativeGradient = sentimentCtx.createLinearGradient(
          positiveWidth,
          0,
          sentimentWidth,
          0
        );
        neutralNegativeGradient.addColorStop(0, neutralColor);
        neutralNegativeGradient.addColorStop(1, negativeColor);

        sentimentCtx.fillStyle = positiveColor;
        sentimentCtx.fillRect(0, 0, positiveWidth, sentimentHeight);

        sentimentCtx.fillStyle = positiveNeutralGradient;
        sentimentCtx.fillRect(positiveWidth, 0, neutralWidth, sentimentHeight);

        sentimentCtx.fillStyle = neutralNegativeGradient;
        sentimentCtx.fillRect(
          positiveWidth + neutralWidth,
          0,
          negativeWidth,
          sentimentHeight
        );

        // ** Bar Chart for Key Metrics **
        const metricsCanvas = document.getElementById("metricsBarChart");
        const metricsCtx = metricsCanvas.getContext("2d");

        const metricValues = {
          Open: 147.3,
          High: 147.38,
          SMA: 144.81,
          RSI: 56.11,
          EMA: 144.47,
        };

        new Chart(metricsCtx, {
          type: "bar",
          data: {
            labels: Object.keys(metricValues),
            datasets: [
              {
                label: "Value",
                data: Object.values(metricValues),
                backgroundColor: [
                  "#ADD8E6", // Light Blue
                  "#87CEEB", // Sky Blue
                  "#4682B4", // Steel Blue
                  "#6495ED", // Cornflower Blue
                  "#1E90FF", // Dodger Blue
                ],
                borderRadius: 12, // Rounded corners
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              x: {
                ticks: {
                  font: {
                    size: 14,
                    weight: "bold",
                  },
                },
              },
              y: {
                beginAtZero: true,
                grid: {
                  display: false,
                },
                ticks: {
                  font: {
                    size: 14,
                    weight: "bold",
                  },
                },
              },
            },
          },
        });
      });
    </script>
  </body>
</html>
